import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously } from 'firebase/auth';
import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, query, where } from 'firebase/firestore';

// Helper function to format numbers with spaces as thousands separators
const formatZAR = (number) => {
  if (number === null || isNaN(number)) return 'R0.00';
  const parts = number.toFixed(2).toString().split('.');
  parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
  return `R${parts.join('.')}`;
};

// Main App component that handles state and navigation
const App = () => {
  // Constants from the environment for Firebase configuration
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  // State to hold Firebase instances and user info
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [isLoading, setIsLoading] = useState(true);

  // State for application data
  const [projects, setProjects] = useState([]);
  const [currentProjectId, setCurrentProjectId] = useState(null);
  const [transactions, setTransactions] = useState([]);
  const [invoices, setInvoices] = useState([]);
  const [budgets, setBudgets] = useState([]);
  const [taxRate, setTaxRate] = useState(25);

  // State for navigation
  const [currentPage, setCurrentPage] = useState('dashboard');

  // Effect for one-time Firebase initialization and authentication
  useEffect(() => {
    try {
      // Initialize Firebase app
      const app = initializeApp(firebaseConfig);
      const firestore = getFirestore(app);
      const firebaseAuth = getAuth(app);
      setDb(firestore);
      setAuth(firebaseAuth);

      // Listen for auth state changes and sign in
      const unsubscribeAuth = onAuthStateChanged(firebaseAuth, async (user) => {
        if (user) {
          setUserId(user.uid);
          // Don't set isLoading to false yet, wait for project data
        } else {
          if (initialAuthToken) {
            await signInWithCustomToken(firebaseAuth, initialAuthToken);
          } else {
            await signInAnonymously(firebaseAuth);
          }
        }
      });

      return () => unsubscribeAuth();
    } catch (error) {
      console.error("Error initializing Firebase:", error);
      setIsLoading(false);
    }
  }, []);

  // Effect to fetch projects and set the initial current project
  useEffect(() => {
    if (db && userId) {
      const projectsPath = `/artifacts/${appId}/users/${userId}/projects`;
      const unsubscribeProjects = onSnapshot(collection(db, projectsPath), (snapshot) => {
        const fetchedProjects = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        setProjects(fetchedProjects);
        if (fetchedProjects.length > 0 && !currentProjectId) {
          setCurrentProjectId(fetchedProjects[0].id);
        } else if (fetchedProjects.length === 0) {
           // If no projects exist, create a default one
           const createDefaultProject = async () => {
             const defaultProjectRef = await addDoc(collection(db, projectsPath), { name: "Milnerton House" });
             setCurrentProjectId(defaultProjectRef.id);
             setProjects([{ id: defaultProjectRef.id, name: "Milnerton House" }]);
             setIsLoading(false);
           }
           createDefaultProject();
        }
        setIsLoading(false);
      }, (error) => {
        console.error("Error fetching projects:", error);
        setIsLoading(false);
      });

      return () => unsubscribeProjects();
    }
  }, [db, userId, appId, currentProjectId]);

  // Effect to fetch data from Firestore for the current project
  useEffect(() => {
    if (db && userId && currentProjectId) {
      const transactionsPath = `/artifacts/${appId}/users/${userId}/transactions`;
      const invoicesPath = `/artifacts/${appId}/users/${userId}/invoices`;
      const budgetsPath = `/artifacts/${appId}/users/${userId}/budgets`;
      
      try {
        const qTransactions = query(collection(db, transactionsPath), where("projectId", "==", currentProjectId));
        const unsubscribeTransactions = onSnapshot(qTransactions, (snapshot) => {
          const fetchedTransactions = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          setTransactions(fetchedTransactions);
        }, (error) => {
          console.error("Error fetching transactions:", error);
        });

        const qInvoices = query(collection(db, invoicesPath), where("projectId", "==", currentProjectId));
        const unsubscribeInvoices = onSnapshot(qInvoices, (snapshot) => {
          const fetchedInvoices = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          setInvoices(fetchedInvoices);
        }, (error) => {
          console.error("Error fetching invoices:", error);
        });

        const qBudgets = query(collection(db, budgetsPath), where("projectId", "==", currentProjectId));
        const unsubscribeBudgets = onSnapshot(qBudgets, (snapshot) => {
          const fetchedBudgets = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          setBudgets(fetchedBudgets);
        }, (error) => {
          console.error("Error fetching budgets:", error);
        });
        
        return () => {
          unsubscribeTransactions();
          unsubscribeInvoices();
          unsubscribeBudgets();
        };

      } catch (error) {
        console.error("Error setting up Firestore listeners:", error);
      }
    }
  }, [db, userId, appId, currentProjectId]);

  // Handler for updating an invoice in the database to mark it as 'Paid'
  const handleMarkAsPaid = async (id) => {
    if (!db || !userId) return;
    try {
      await updateDoc(doc(db, `/artifacts/${appId}/users/${userId}/invoices`, id), {
        status: 'Paid',
      });
    } catch (e) {
      console.error("Error updating invoice status: ", e);
    }
  };

  // Handler for creating a new project
  const handleAddProject = async (projectName) => {
    if (!db || !userId) return;
    try {
      const newProjectRef = await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/projects`), {
        name: projectName
      });
      setCurrentProjectId(newProjectRef.id);
    } catch (e) {
      console.error("Error adding new project: ", e);
    }
  };

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-100 font-sans">
        <div className="text-center">
          <svg className="animate-spin h-10 w-10 text-indigo-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <p className="text-lg text-gray-700">Loading data...</p>
        </div>
      </div>
    );
  }

  const currentProjectName = projects.find(p => p.id === currentProjectId)?.name || "No Project Selected";

  return (
    <div className="min-h-screen bg-gray-100 p-4 sm:p-8 font-sans">
      <div className="bg-white rounded-xl shadow-lg p-6 sm:p-8">
        <h1 className="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-2">Twiza Projects Management</h1>
        
        {/* Project Selector and User ID */}
        <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6">
          <ProjectSelector
            projects={projects}
            currentProjectId={currentProjectId}
            setCurrentProjectId={setCurrentProjectId}
            onAddProject={handleAddProject}
          />
          {userId && (
            <p className="text-sm text-gray-500 mt-2 sm:mt-0">User ID: {userId}</p>
          )}
        </div>

        <h2 className="text-xl sm:text-2xl font-bold text-gray-600 mb-2">Project: {currentProjectName}</h2>
        

        {/* Navigation Tabs */}
        <div className="flex flex-wrap gap-2 mb-8 border-b border-gray-200">
          <button
            onClick={() => setCurrentPage('dashboard')}
            className={`px-4 py-2 font-semibold transition-colors duration-200 ${currentPage === 'dashboard' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-gray-500 hover:text-indigo-600'}`}
          >
            Dashboard
          </button>
          <button
            onClick={() => setCurrentPage('transactions')}
            className={`px-4 py-2 font-semibold transition-colors duration-200 ${currentPage === 'transactions' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-gray-500 hover:text-indigo-600'}`}
          >
            Transaction Ledger
          </button>
          <button
            onClick={() => setCurrentPage('invoices')}
            className={`px-4 py-2 font-semibold transition-colors duration-200 ${currentPage === 'invoices' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-gray-500 hover:text-indigo-600'}`}
          >
            Invoices
          </button>
          <button
            onClick={() => setCurrentPage('reports')}
            className={`px-4 py-2 font-semibold transition-colors duration-200 ${currentPage === 'reports' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-gray-500 hover:text-indigo-600'}`}
          >
            Reports & Budgeting
          </button>
        </div>

        {/* Render content based on current page */}
        {(() => {
          switch (currentPage) {
            case 'dashboard':
              return (
                <Dashboard
                  transactions={transactions}
                  invoices={invoices}
                  taxRate={taxRate}
                  setTaxRate={setTaxRate}
                />
              );
            case 'transactions':
              return (
                <TransactionLedger
                  transactions={transactions}
                  db={db}
                  userId={userId}
                  appId={appId}
                  currentProjectId={currentProjectId}
                />
              );
            case 'invoices':
              return (
                <Invoices
                  invoices={invoices}
                  db={db}
                  userId={userId}
                  appId={appId}
                  currentProjectId={currentProjectId}
                  onMarkAsPaid={handleMarkAsPaid}
                />
              );
            case 'reports':
              return (
                <FinancialReports
                  transactions={transactions}
                  budgets={budgets}
                  db={db}
                  userId={userId}
                  appId={appId}
                  currentProjectId={currentProjectId}
                />
              );
            default:
              return null;
          }
        })()}
      </div>
    </div>
  );
};

// =================================================================================================
// Reusable Confirmation Modal Component
// =================================================================================================
const ConfirmationModal = ({ message, onConfirm, onCancel }) => {
  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
      <div className="relative bg-white rounded-lg shadow-xl p-8 w-11/12 md:w-1/3">
        <h3 className="text-xl font-bold mb-4 text-center">Confirm Deletion</h3>
        <p className="text-center text-gray-700 mb-6">{message}</p>
        <div className="flex justify-center gap-4">
          <button
            onClick={onCancel}
            className="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors"
          >
            Cancel
          </button>
          <button
            onClick={onConfirm}
            className="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors"
          >
            Delete
          </button>
        </div>
      </div>
    </div>
  );
};

// =================================================================================================
// Project Selector Component
// =================================================================================================
const ProjectSelector = ({ projects, currentProjectId, setCurrentProjectId, onAddProject }) => {
  const [showAddProjectModal, setShowAddProjectModal] = useState(false);
  const [newProjectName, setNewProjectName] = useState('');

  const handleAddProject = () => {
    if (newProjectName.trim() !== '') {
      onAddProject(newProjectName.trim());
      setNewProjectName('');
      setShowAddProjectModal(false);
    }
  };

  return (
    <>
      <div className="flex items-center gap-4">
        <label htmlFor="project-select" className="text-gray-700 font-semibold">Current Project:</label>
        <select
          id="project-select"
          value={currentProjectId || ''}
          onChange={(e) => setCurrentProjectId(e.target.value)}
          className="p-2 border rounded-md shadow-sm bg-white"
        >
          {projects.map(project => (
            <option key={project.id} value={project.id}>{project.name}</option>
          ))}
        </select>
        <button
          onClick={() => setShowAddProjectModal(true)}
          className="bg-indigo-500 text-white px-3 py-2 rounded-lg shadow-sm hover:bg-indigo-600 transition-colors duration-200 text-sm"
        >
          Add New Project
        </button>
      </div>

      {/* Add Project Modal */}
      {showAddProjectModal && (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
          <div className="relative bg-white rounded-lg shadow-xl p-8 w-11/12 md:w-1/3">
            <h3 className="text-2xl font-bold mb-4">Add New Project</h3>
            <input
              type="text"
              placeholder="Enter project name..."
              value={newProjectName}
              onChange={(e) => setNewProjectName(e.target.value)}
              className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-4"
              onKeyPress={(e) => {
                if (e.key === 'Enter') handleAddProject();
              }}
            />
            <div className="flex justify-end gap-4">
              <button
                type="button"
                onClick={() => setShowAddProjectModal(false)}
                className="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors"
              >
                Cancel
              </button>
              <button
                onClick={handleAddProject}
                className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors"
              >
                Add Project
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  );
};

// =================================================================================================
// Dashboard Component
// =================================================================================================
const Dashboard = ({ transactions, invoices, taxRate, setTaxRate }) => {
  const [tooltip, setTooltip] = useState({ visible: false, x: 0, y: 0, content: '' });

  // Memoize summary calculations to prevent re-computation on every render
  const summary = useMemo(() => {
    const totalIncome = transactions.reduce((acc, curr) => acc + parseFloat(curr.grossIncome || 0), 0);
    const totalExpenses = transactions.reduce((acc, curr) => acc + parseFloat(curr.expenses || 0), 0);
    const totalInvoicesDue = invoices.filter(inv => inv.status === 'Outstanding').reduce((acc, curr) => acc + parseFloat(curr.amountDue || 0), 0);
    const taxableIncome = totalIncome - totalExpenses;
    const grossProfit = totalIncome - totalExpenses;
    const estimatedTax = taxableIncome > 0 ? taxableIncome * (taxRate / 100) : 0;
    return { totalIncome, totalExpenses, grossProfit, taxableIncome, estimatedTax, totalInvoicesDue };
  }, [transactions, invoices, taxRate]);

  // Memoize data for the monthly profit chart
  const monthlyProfitData = useMemo(() => {
    const monthlyData = {};
    transactions.forEach(t => {
      const date = new Date(t.date);
      if (!isNaN(date.getTime())) {
        const monthYear = date.toISOString().slice(0, 7); // YYYY-MM
        if (!monthlyData[monthYear]) {
          monthlyData[monthYear] = { income: 0, expenses: 0 };
        }
        monthlyData[monthYear].income += parseFloat(t.grossIncome || 0);
        monthlyData[monthYear].expenses += parseFloat(t.expenses || 0);
      }
    });
    const sortedMonths = Object.keys(monthlyData).sort();
    return sortedMonths.map(month => ({
      month,
      profit: monthlyData[month].income - monthlyData[month].expenses
    }));
  }, [transactions]);

  // Memoize data for the expense category pie chart
  const expenseCategoryData = useMemo(() => {
    const categories = {};
    transactions.forEach(t => {
      const category = t.category || 'Uncategorized';
      const expenses = parseFloat(t.expenses || 0);
      if (expenses > 0) {
        categories[category] = (categories[category] || 0) + expenses;
      }
    });
    const totalExpenses = Object.values(categories).reduce((sum, val) => sum + val, 0);
    return Object.keys(categories).map(key => ({
      category: key,
      value: categories[key],
      percentage: (categories[key] / totalExpenses) * 100
    }));
  }, [transactions]);
  
  // Color palette for the pie chart
  const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800', '#ff5722', '#795548', '#9e9e9e', '#607d8b'];
  let startAngle = 0;

  // Handlers for chart tooltip
  const handleBarHover = (e, data) => {
    setTooltip({
      visible: true,
      x: e.clientX,
      y: e.clientY,
      content: `${data.month}: ${formatZAR(data.profit)}`
    });
  };
  const handleLeave = () => {
    setTooltip({ visible: false, x: 0, y: 0, content: '' });
  };
  const handlePieHover = (e, data) => {
    setTooltip({
      visible: true,
      x: e.clientX,
      y: e.clientY,
      content: `${data.category}: ${formatZAR(data.value)} (${data.percentage.toFixed(1)}%)`
    });
  };

  return (
    <div>
      {/* Financial Summary Section */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
        <div className="bg-green-100 p-6 rounded-lg shadow-sm">
          <p className="text-lg font-semibold text-gray-700">Total Gross Revenue</p>
          <p className="text-3xl font-bold text-green-600">{formatZAR(summary.totalIncome)}</p>
        </div>
        <div className="bg-red-100 p-6 rounded-lg shadow-sm">
          <p className="text-lg font-semibold text-gray-700">Total Deductible Expenses</p>
          <p className="text-3xl font-bold text-red-600">{formatZAR(summary.totalExpenses)}</p>
        </div>
        <div className="bg-blue-100 p-6 rounded-lg shadow-sm">
          <p className="text-lg font-semibold text-gray-700">Net Taxable Income</p>
          <p className="text-3xl font-bold text-blue-600">{formatZAR(summary.taxableIncome)}</p>
        </div>
        <div className="bg-purple-100 p-6 rounded-lg shadow-sm">
          <p className="text-lg font-semibold text-gray-700">Estimated Tax Liability</p>
          <p className="text-3xl font-bold text-purple-600">{formatZAR(summary.estimatedTax)}</p>
        </div>
        <div className="bg-yellow-100 p-6 rounded-lg shadow-sm">
          <p className="text-lg font-semibold text-gray-700">Total Outstanding Invoices</p>
          <p className="text-3xl font-bold text-yellow-600">{formatZAR(summary.totalInvoicesDue)}</p>
        </div>
        <div className="p-6 rounded-lg shadow-sm flex flex-col items-center justify-center">
          <label htmlFor="taxRate" className="text-lg font-semibold text-gray-700 mb-2">
            Tax Rate (%)
          </label>
          <input
            type="number"
            id="taxRate"
            name="taxRate"
            value={isNaN(taxRate) ? '' : taxRate}
            onChange={(e) => setTaxRate(parseFloat(e.target.value) || 0)}
            className="w-full text-center p-2 rounded-md border border-gray-300 text-lg font-bold"
          />
        </div>
      </div>

      {/* Charts Section */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        {/* Monthly Profit Bar Chart */}
        <div className="bg-gray-50 rounded-xl p-6 shadow-md">
          <h3 className="text-2xl font-bold text-gray-800 mb-4">Monthly Profit Analysis</h3>
          <div className="w-full overflow-x-auto relative" onMouseLeave={handleLeave}>
            {monthlyProfitData.length > 0 ? (
              <svg viewBox={`0 -30 650 260`} className="w-full h-auto">
                <line x1="50" y1="200" x2="650" y2="200" stroke="#000" />
                <line x1="50" y1="0" x2="50" y2="200" stroke="#000" />
                
                {monthlyProfitData.map((data, index) => {
                  const chartHeight = 200;
                  const maxProfit = Math.max(...monthlyProfitData.map(d => d.profit), 0);
                  const minProfit = Math.min(...monthlyProfitData.map(d => d.profit), 0);
                  const yAxisScale = chartHeight / (maxProfit - minProfit || 1);
                  const barWidth = 40;
                  const gap = (600 - (monthlyProfitData.length * barWidth)) / (monthlyProfitData.length + 1);
                  const xPos = 50 + (index * (barWidth + gap)) + gap;
                  const barHeight = Math.abs(data.profit * yAxisScale);
                  const yPos = data.profit >= 0 ? chartHeight - barHeight : chartHeight;
                  return (
                    <React.Fragment key={data.month}>
                      <rect 
                        x={xPos} 
                        y={yPos}
                        width={barWidth} 
                        height={barHeight} 
                        fill={data.profit >= 0 ? 'rgba(52, 211, 153, 0.8)' : 'rgba(239, 68, 68, 0.8)'} 
                        rx="4"
                        onMouseEnter={(e) => handleBarHover(e, data)}
                      />
                      <text 
                        x={xPos + barWidth / 2} 
                        y={chartHeight + 15} 
                        textAnchor="middle" 
                        fontSize="12"
                        fill="#4b5563"
                      >
                        {data.month}
                      </text>
                       <text 
                        x={xPos + barWidth / 2} 
                        y={data.profit >= 0 ? yPos - 5 : yPos + 15} 
                        textAnchor="middle" 
                        fontSize="10" 
                        fill="#1f2937"
                      >
                        {data.profit.toFixed(0)}
                      </text>
                    </React.Fragment>
                  );
                })}
              </svg>
            ) : (
              <p className="text-center text-gray-500 py-8">No transaction data available to plot profit.</p>
            )}
            {tooltip.visible && (
              <div
                style={{
                  position: 'absolute',
                  left: tooltip.x,
                  top: tooltip.y,
                  transform: 'translate(-50%, -120%)',
                  backgroundColor: 'rgba(0,0,0,0.7)',
                  color: 'white',
                  padding: '5px 10px',
                  borderRadius: '5px',
                  pointerEvents: 'none',
                }}
                className="z-10"
              >
                {tooltip.content}
              </div>
            )}
          </div>
        </div>

        {/* Expense Category Pie Chart */}
        <div className="bg-gray-50 rounded-xl p-6 shadow-md">
          <h3 className="text-2xl font-bold text-gray-800 mb-4">Expense Breakdown by Category</h3>
          <div className="flex flex-col items-center relative" onMouseLeave={handleLeave}>
            {expenseCategoryData.length > 0 ? (
              <svg width="250" height="250" viewBox="0 0 250 250">
                {expenseCategoryData.map((data, index) => {
                  const angle = (data.percentage / 100) * 360;
                  const endAngle = startAngle + angle;
                  const largeArcFlag = angle > 180 ? 1 : 0;
                  const radius = 100;
                  const x1 = 125 + radius * Math.cos(startAngle * Math.PI / 180);
                  const y1 = 125 + radius * Math.sin(startAngle * Math.PI / 180);
                  const x2 = 125 + radius * Math.cos(endAngle * Math.PI / 180);
                  const y2 = 125 + radius * Math.sin(endAngle * Math.PI / 180);
                  
                  const d = [
                    `M 125,125`,
                    `L ${x1},${y1}`,
                    `A ${radius},${radius} 0 ${largeArcFlag} 1 ${x2},${y2}`,
                    `Z`
                  ].join(' ');
                  
                  const color = colors[index % colors.length];
                  
                  // Update startAngle for the next slice
                  startAngle = endAngle;

                  // Label position
                  const labelAngle = startAngle - (angle / 2);
                  const labelX = 125 + (radius / 1.5) * Math.cos(labelAngle * Math.PI / 180);
                  const labelY = 125 + (radius / 1.5) * Math.sin(labelAngle * Math.PI / 180);

                  return (
                    <React.Fragment key={data.category}>
                      <path 
                        d={d} 
                        fill={color} 
                        stroke="#fff" 
                        strokeWidth="2" 
                        onMouseEnter={(e) => handlePieHover(e, data)}
                      />
                      {data.percentage > 5 && ( // Only show labels for slices > 5% to avoid clutter
                        <text
                          x={labelX}
                          y={labelY}
                          textAnchor="middle"
                          alignmentBaseline="middle"
                          fontSize="12"
                          fontWeight="bold"
                          fill="#fff"
                        >
                          {data.percentage.toFixed(0)}%
                        </text>
                      )}
                    </React.Fragment>
                  );
                })}
              </svg>
            ) : (
              <p className="text-center text-gray-500 py-8">No expenses to display in the pie chart.</p>
            )}

            {/* Legend for pie chart */}
            <div className="flex flex-wrap justify-center gap-4 mt-4">
              {expenseCategoryData.map((data, index) => (
                <div key={data.category} className="flex items-center">
                  <span
                    className="w-4 h-4 rounded-full mr-2"
                    style={{ backgroundColor: colors[index % colors.length] }}
                  ></span>
                  <span className="text-sm text-gray-700">{data.category}</span>
                </div>
              ))}
            </div>
             {tooltip.visible && (
              <div
                style={{
                  position: 'absolute',
                  left: tooltip.x,
                  top: tooltip.y,
                  transform: 'translate(-50%, -120%)',
                  backgroundColor: 'rgba(0,0,0,0.7)',
                  color: 'white',
                  padding: '5px 10px',
                  borderRadius: '5px',
                  pointerEvents: 'none',
                }}
                className="z-10"
              >
                {tooltip.content}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

// =================================================================================================
// Transaction Ledger Component
// =================================================================================================
const TransactionLedger = ({ transactions, db, userId, appId, currentProjectId }) => {
  // State for sorting, filtering, and the form modal
  const [transactionSort, setTransactionSort] = useState({ field: 'date', order: 'asc' });
  const [transactionFilter, setTransactionFilter] = useState('');
  const [showModal, setShowModal] = useState(false);
  const [currentTransaction, setCurrentTransaction] = useState(null);
  const [confirmModal, setConfirmModal] = useState({ visible: false, message: '', onConfirm: null });

  // Handlers for modal
  const handleOpenModal = (transaction = null) => {
    setCurrentTransaction(transaction);
    setShowModal(true);
  };
  const handleCloseModal = () => {
    setShowModal(false);
    setCurrentTransaction(null);
  };

  // Handler for adding a new transaction to the database
  const handleAddOrUpdateTransaction = async (newTransaction) => {
    if (!db || !userId || !currentProjectId) return;
    try {
      if (newTransaction.id) {
        await updateDoc(doc(db, `/artifacts/${appId}/users/${userId}/transactions`, newTransaction.id), newTransaction);
      } else {
        await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/transactions`), {
          ...newTransaction,
          projectId: currentProjectId
        });
      }
      handleCloseModal();
    } catch (e) {
      console.error("Error adding or updating transaction: ", e);
    }
  };

  // Handler for deleting a transaction from the database
  const handleDeleteTransaction = (id) => {
    setConfirmModal({
      visible: true,
      message: 'Are you sure you want to delete this transaction? This action cannot be undone.',
      onConfirm: () => confirmDeleteTransaction(id),
      onCancel: () => setConfirmModal({ visible: false, message: '', onConfirm: null }),
    });
  };

  // Function to perform the actual deletion after confirmation
  const confirmDeleteTransaction = async (id) => {
    setConfirmModal({ visible: false, message: '', onConfirm: null });
    if (!db || !userId) return;
    try {
      await deleteDoc(doc(db, `/artifacts/${appId}/users/${userId}/transactions`, id));
    } catch (e) {
      console.error("Error deleting transaction: ", e);
    }
  };

  // Sort handler for transactions
  const handleTransactionSort = (field) => {
    setTransactionSort(prevSort => ({
      field,
      order: prevSort.field === field && prevSort.order === 'asc' ? 'desc' : 'asc',
    }));
  };

  // Get filtered and sorted transactions
  const getFilteredAndSortedTransactions = () => {
    const filtered = transactions.filter(t => 
      Object.values(t).some(value => 
        String(value).toLowerCase().includes(transactionFilter.toLowerCase())
      )
    );

    const sorted = [...filtered].sort((a, b) => {
      const aVal = a[transactionSort.field];
      const bVal = b[transactionSort.field];
      if (typeof aVal === 'string' && typeof bVal === 'string') {
        return transactionSort.order === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
      }
      return transactionSort.order === 'asc' ? aVal - bVal : bVal - aVal;
    });
    return sorted;
  };
  
  return (
    <>
      <h3 className="text-2xl font-bold text-gray-800 mb-4">Transaction Ledger</h3>
      <div className="flex gap-4 mb-4">
        <input 
          type="text"
          placeholder="Filter transactions..."
          className="w-full p-2 rounded-md border border-gray-300"
          value={transactionFilter}
          onChange={(e) => setTransactionFilter(e.target.value)}
        />
        <button
          onClick={() => handleOpenModal()}
          className="bg-indigo-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200"
        >
          Add Transaction
        </button>
      </div>
      <div className="overflow-x-auto rounded-lg shadow-md mb-8">
        <table className="min-w-full divide-y divide-gray-200 table-fixed">
          <thead className="bg-gray-50">
            <tr>
              <th 
                className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer w-32"
                onClick={() => handleTransactionSort('date')}
              >
                Date {transactionSort.field === 'date' ? (transactionSort.order === 'asc' ? '▲' : '▼') : ''}
              </th>
              <th 
                className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer w-64"
                onClick={() => handleTransactionSort('description')}
              >
                Description {transactionSort.field === 'description' ? (transactionSort.order === 'asc' ? '▲' : '▼') : ''}
              </th>
              <th 
                className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer w-48"
                onClick={() => handleTransactionSort('category')}
              >
                Category {transactionSort.field === 'category' ? (transactionSort.order === 'asc' ? '▲' : '▼') : ''}
              </th>
              <th 
                className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer w-32"
                onClick={() => handleTransactionSort('grossIncome')}
              >
                Income (R) {transactionSort.field === 'grossIncome' ? (transactionSort.order === 'asc' ? '▲' : '▼') : ''}
              </th>
              <th 
                className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer w-32"
                onClick={() => handleTransactionSort('expenses')}
              >
                Expenses (R) {transactionSort.field === 'expenses' ? (transactionSort.order === 'asc' ? '▲' : '▼') : ''}
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-64">Notes</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Actions</th>
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {getFilteredAndSortedTransactions().map((transaction) => (
              <tr key={transaction.id}>
                <td className="px-6 py-4">{transaction.date}</td>
                <td className="px-6 py-4">{transaction.description}</td>
                <td className="px-6 py-4">{transaction.category}</td>
                <td className="px-6 py-4">{formatZAR(transaction.grossIncome)}</td>
                <td className="px-6 py-4">{formatZAR(transaction.expenses)}</td>
                <td className="px-6 py-4">{transaction.notes}</td>
                <td className="px-6 py-4">
                  <div className="flex gap-2">
                    <button
                      onClick={() => handleOpenModal(transaction)}
                      className="text-indigo-600 hover:text-indigo-900 transition-colors duration-200"
                    >
                      Edit
                    </button>
                    <button
                      onClick={() => handleDeleteTransaction(transaction.id)}
                      className="text-red-600 hover:text-red-900 transition-colors duration-200"
                    >
                      Delete
                    </button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {showModal && (
        <TransactionModal
          transaction={currentTransaction}
          onSave={handleAddOrUpdateTransaction}
          onClose={handleCloseModal}
        />
      )}
      {confirmModal.visible && (
        <ConfirmationModal
          message={confirmModal.message}
          onConfirm={confirmModal.onConfirm}
          onCancel={() => setConfirmModal({ visible: false })}
        />
      )}
    </>
  );
};

// Transaction Modal Form Component
const TransactionModal = ({ transaction, onSave, onClose }) => {
  const [formData, setFormData] = useState(transaction || {
    date: new Date().toISOString().slice(0, 10),
    description: '',
    category: '',
    grossIncome: 0,
    expenses: 0,
    notes: ''
  });
  const [validationError, setValidationError] = useState('');

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: name === 'grossIncome' || name === 'expenses' ? parseFloat(value) || 0 : value
    }));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    // Validate numerical inputs
    if (isNaN(formData.grossIncome) || formData.grossIncome < 0 || isNaN(formData.expenses) || formData.expenses < 0) {
      setValidationError('Income and Expenses must be valid positive numbers.');
      return;
    }
    setValidationError('');
    onSave(formData);
  };

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
      <div className="relative bg-white rounded-lg shadow-xl p-8 w-11/12 md:w-1/2">
        <h3 className="text-2xl font-bold mb-6">{transaction ? 'Edit Transaction' : 'Add Transaction'}</h3>
        <form onSubmit={handleSubmit}>
          <div className="mb-4">
            <label className="block text-gray-700 text-sm font-bold mb-2">Date</label>
            <input type="date" name="date" value={formData.date} onChange={handleChange} className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required />
          </div>
          <div className="mb-4">
            <label className="block text-gray-700 text-sm font-bold mb-2">Description</label>
            <input type="text" name="description" value={formData.description} onChange={handleChange} className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required />
          </div>
          <div className="mb-4">
            <label className="block text-gray-700 text-sm font-bold mb-2">Category</label>
            <input type="text" name="category" value={formData.category} onChange={handleChange} className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" />
          </div>
          <div className="mb-4">
            <label className="block text-gray-700 text-sm font-bold mb-2">Gross Income (R)</label>
            <input type="number" name="grossIncome" value={formData.grossIncome} onChange={handleChange} className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" />
          </div>
          <div className="mb-4">
            <label className="block text-gray-700 text-sm font-bold mb-2">Expenses (R)</label>
            <input type="number" name="expenses" value={formData.expenses} onChange={handleChange} className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" />
          </div>
          <div className="mb-4">
            <label className="block text-gray-700 text-sm font-bold mb-2">Notes</label>
            <input type="text" name="notes" value={formData.notes} onChange={handleChange} className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" />
          </div>
          {validationError && <p className="text-red-500 text-sm italic mt-2 mb-4">{validationError}</p>}
          <div className="flex justify-end gap-4">
            <button type="button" onClick={onClose} className="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">Cancel</button>
            <button type="submit" className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">{transaction ? 'Update' : 'Add'}</button>
          </div>
        </form>
      </div>
    </div>
  );
};

// =================================================================================================
// Invoices Component
// =================================================================================================
const Invoices = ({ invoices, db, userId, appId, currentProjectId, onMarkAsPaid }) => {
  // State for sorting, filtering, and the form modal
  const [invoiceSort, setInvoiceSort] = useState({ field: 'invoiceDate', order: 'asc' });
  const [invoiceFilter, setInvoiceFilter] = useState('');
  const [showModal, setShowModal] = useState(false);
  const [currentInvoice, setCurrentInvoice] = useState(null);
  const [confirmModal, setConfirmModal] = useState({ visible: false, message: '', onConfirm: null });

  // Handlers for modal
  const handleOpenModal = (invoice = null) => {
    setCurrentInvoice(invoice);
    setShowModal(true);
  };
  const handleCloseModal = () => {
    setShowModal(false);
    setCurrentInvoice(null);
  };

  // Handler for adding a new invoice to the database
  const handleAddOrUpdateInvoice = async (newInvoice) => {
    if (!db || !userId || !currentProjectId) return;
    try {
      if (newInvoice.id) {
        await updateDoc(doc(db, `/artifacts/${appId}/users/${userId}/invoices`, newInvoice.id), newInvoice);
      } else {
        await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/invoices`), {
          ...newInvoice,
          projectId: currentProjectId
        });
      }
      handleCloseModal();
    } catch (e) {
      console.error("Error adding or updating invoice: ", e);
    }
  };

  // Handler for deleting an invoice from the database
  const handleDeleteInvoice = (id) => {
    setConfirmModal({
      visible: true,
      message: 'Are you sure you want to delete this invoice? This action cannot be undone.',
      onConfirm: () => confirmDeleteInvoice(id),
      onCancel: () => setConfirmModal({ visible: false, message: '', onConfirm: null }),
    });
  };

  // Function to perform the actual deletion after confirmation
  const confirmDeleteInvoice = async (id) => {
    setConfirmModal({ visible: false, message: '', onConfirm: null });
    if (!db || !userId) return;
    try {
      await deleteDoc(doc(db, `/artifacts/${appId}/users/${userId}/invoices`, id));
    } catch (e) {
      console.error("Error deleting invoice: ", e);
    }
  };


  // Sort handler for invoices
  const handleInvoiceSort = (field) => {
    setInvoiceSort(prevSort => ({
      field,
      order: prevSort.field === field && prevSort.order === 'asc' ? 'desc' : 'asc',
    }));
  };

  // Get filtered and sorted invoices
  const getFilteredAndSortedInvoices = () => {
    const filtered = invoices.filter(inv => 
      Object.values(inv).some(value => 
        String(value).toLowerCase().includes(invoiceFilter.toLowerCase())
      )
    );

    const sorted = [...filtered].sort((a, b) => {
      const aVal = a[invoiceSort.field];
      const bVal = b[invoiceSort.field];
      if (typeof aVal === 'string' && typeof bVal === 'string') {
        return invoiceSort.order === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
      }
      return invoiceSort.order === 'asc' ? aVal - bVal : bVal - aVal;
    });
    return sorted;
  };

  return (
    <>
      <h3 className="text-2xl font-bold text-gray-800 mb-4">Invoices</h3>
      <div className="flex gap-4 mb-4">
        <input 
          type="text"
          placeholder="Filter invoices..."
          className="w-full p-2 rounded-md border border-gray-300"
          value={invoiceFilter}
          onChange={(e) => setInvoiceFilter(e.target.value)}
        />
        <button
          onClick={() => handleOpenModal()}
          className="bg-indigo-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200"
        >
          Add Invoice
        </button>
      </div>
      <div className="overflow-x-auto rounded-lg shadow-md mb-8">
        <table className="min-w-full divide-y divide-gray-200 table-fixed">
          <thead className="bg-gray-50">
            <tr>
              <th 
                className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer w-32"
                onClick={() => handleInvoiceSort('invoiceNum')}
              >
                Invoice # {invoiceSort.field === 'invoiceNum' ? (invoiceSort.order === 'asc' ? '▲' : '▼') : ''}
              </th>
              <th 
                className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer w-48"
                onClick={() => handleInvoiceSort('client')}
              >
                Client Name {invoiceSort.field === 'client' ? (invoiceSort.order === 'asc' ? '▲' : '▼') : ''}
              </th>
              <th 
                className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer w-48"
                onClick={() => handleInvoiceSort('project')}
              >
                Project {invoiceSort.field === 'project' ? (invoiceSort.order === 'asc' ? '▲' : '▼') : ''}
              </th>
              <th 
                className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer w-32"
                onClick={() => handleInvoiceSort('dueDate')}
              >
                Due Date {invoiceSort.field === 'dueDate' ? (invoiceSort.order === 'asc' ? '▲' : '▼') : ''}
              </th>
              <th 
                className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer w-32"
                onClick={() => handleInvoiceSort('amountDue')}
              >
                Amount Due (R) {invoiceSort.field === 'amountDue' ? (invoiceSort.order === 'asc' ? '▲' : '▼') : ''}
              </th>
              <th 
                className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer w-32"
                onClick={() => handleInvoiceSort('status')}
              >
                Status {invoiceSort.field === 'status' ? (invoiceSort.order === 'asc' ? '▲' : '▼') : ''}
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Actions</th>
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {getFilteredAndSortedInvoices().map((invoice) => (
              <tr key={invoice.id}>
                <td className="px-6 py-4">{invoice.invoiceNum}</td>
                <td className="px-6 py-4">{invoice.client}</td>
                <td className="px-6 py-4">{invoice.project}</td>
                <td className="px-6 py-4">{invoice.dueDate}</td>
                <td className="px-6 py-4">{formatZAR(invoice.amountDue)}</td>
                <td className="px-6 py-4">
                  <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${invoice.status === 'Outstanding' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}`}>
                    {invoice.status}
                  </span>
                </td>
                <td className="px-6 py-4">
                  <div className="flex gap-2">
                    {invoice.status === 'Outstanding' && (
                      <button
                        onClick={() => onMarkAsPaid(invoice.id)}
                        className="text-green-600 hover:text-green-900 transition-colors duration-200 text-sm font-semibold"
                      >
                        Paid
                      </button>
                    )}
                    <button
                      onClick={() => handleOpenModal(invoice)}
                      className="text-indigo-600 hover:text-indigo-900 transition-colors duration-200 text-sm font-semibold"
                    >
                      Edit
                    </button>
                    <button
                      onClick={() => handleDeleteInvoice(invoice.id)}
                      className="text-red-600 hover:text-red-900 transition-colors duration-200 text-sm font-semibold"
                    >
                      Delete
                    </button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {showModal && (
        <InvoiceModal
          invoice={currentInvoice}
          onSave={handleAddOrUpdateInvoice}
          onClose={handleCloseModal}
        />
      )}
      {confirmModal.visible && (
        <ConfirmationModal
          message={confirmModal.message}
          onConfirm={confirmModal.onConfirm}
          onCancel={() => setConfirmModal({ visible: false })}
        />
      )}
    </>
  );
};

// Invoice Modal Form Component
const InvoiceModal = ({ invoice, onSave, onClose }) => {
  const [formData, setFormData] = useState(invoice || {
    invoiceNum: '',
    client: '',
    project: '',
    invoiceDate: new Date().toISOString().slice(0, 10),
    dueDate: '',
    amountDue: 0,
    status: 'Outstanding'
  });
  const [validationError, setValidationError] = useState('');

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: name === 'amountDue' ? parseFloat(value) || 0 : value
    }));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    // Validate numerical inputs
    if (isNaN(formData.amountDue) || formData.amountDue < 0) {
      setValidationError('Amount Due must be a valid positive number.');
      return;
    }
    setValidationError('');
    onSave(formData);
  };

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
      <div className="relative bg-white rounded-lg shadow-xl p-8 w-11/12 md:w-1/2">
        <h3 className="text-2xl font-bold mb-6">{invoice ? 'Edit Invoice' : 'Add Invoice'}</h3>
        <form onSubmit={handleSubmit}>
          <div className="mb-4">
            <label className="block text-gray-700 text-sm font-bold mb-2">Invoice #</label>
            <input type="text" name="invoiceNum" value={formData.invoiceNum} onChange={handleChange} className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required />
          </div>
          <div className="mb-4">
            <label className="block text-gray-700 text-sm font-bold mb-2">Client Name</label>
            <input type="text" name="client" value={formData.client} onChange={handleChange} className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required />
          </div>
          <div className="mb-4">
            <label className="block text-gray-700 text-sm font-bold mb-2">Project</label>
            <input type="text" name="project" value={formData.project} onChange={handleChange} className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" />
          </div>
          <div className="mb-4">
            <label className="block text-gray-700 text-sm font-bold mb-2">Invoice Date</label>
            <input type="date" name="invoiceDate" value={formData.invoiceDate} onChange={handleChange} className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required />
          </div>
          <div className="mb-4">
            <label className="block text-gray-700 text-sm font-bold mb-2">Due Date</label>
            <input type="date" name="dueDate" value={formData.dueDate} onChange={handleChange} className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" />
          </div>
          <div className="mb-4">
            <label className="block text-gray-700 text-sm font-bold mb-2">Amount Due (R)</label>
            <input type="number" name="amountDue" value={formData.amountDue} onChange={handleChange} className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required />
          </div>
          <div className="mb-4">
            <label className="block text-gray-700 text-sm font-bold mb-2">Status</label>
            <select name="status" value={formData.status} onChange={handleChange} className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700">
              <option>Outstanding</option>
              <option>Paid</option>
            </select>
          </div>
          {validationError && <p className="text-red-500 text-sm italic mt-2 mb-4">{validationError}</p>}
          <div className="flex justify-end gap-4">
            <button type="button" onClick={onClose} className="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">Cancel</button>
            <button type="submit" className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">{invoice ? 'Update' : 'Add'}</button>
          </div>
        </form>
      </div>
    </div>
  );
};

// =================================================================================================
// Financial Reports & Budgeting Component
// =================================================================================================
const FinancialReports = ({ transactions, budgets, db, userId, appId, currentProjectId }) => {
  const [reportType, setReportType] = useState('pnl');
  const [confirmModal, setConfirmModal] = useState({ visible: false, message: '', onConfirm: null });

  const pnlData = useMemo(() => {
    const incomeBySource = {};
    const expensesByCategory = {};
    transactions.forEach(t => {
      if (t.grossIncome > 0) {
        const category = t.category || 'Uncategorized Income';
        incomeBySource[category] = (incomeBySource[category] || 0) + t.grossIncome;
      }
      if (t.expenses > 0) {
        const category = t.category || 'Uncategorized Expense';
        expensesByCategory[category] = (expensesByCategory[category] || 0) + t.expenses;
      }
    });

    const totalIncome = Object.values(incomeBySource).reduce((sum, val) => sum + val, 0);
    const totalExpenses = Object.values(expensesByCategory).reduce((sum, val) => sum + val, 0);
    const netProfit = totalIncome - totalExpenses;

    return { incomeBySource, expensesByCategory, totalIncome, totalExpenses, netProfit };
  }, [transactions]);

  const budgetData = useMemo(() => {
    const actualSpending = {};
    transactions.forEach(t => {
      const category = t.category || 'Uncategorized Expense';
      if (t.expenses > 0) {
        actualSpending[category] = (actualSpending[category] || 0) + t.expenses;
      }
    });

    const comparison = budgets.map(budget => {
      const actual = actualSpending[budget.category] || 0;
      const variance = (budget.amount || 0) - actual;
      return {
        ...budget,
        actual,
        variance
      };
    });
    return comparison;
  }, [transactions, budgets]);

  const handleUpdateBudget = async (budget, field, value) => {
    if (!db || !userId) return;
    try {
      await updateDoc(doc(db, `/artifacts/${appId}/users/${userId}/budgets`, budget.id), {
        [field]: value
      });
    } catch (e) {
      console.error("Error updating budget: ", e);
    }
  };

  const handleAddBudget = async () => {
    if (!db || !userId || !currentProjectId) return;
    try {
      await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/budgets`), {
        category: '',
        amount: 0,
        notes: '',
        projectId: currentProjectId
      });
    } catch (e) {
      console.error("Error adding budget: ", e);
    }
  };

  const handleDeleteBudget = (id) => {
    setConfirmModal({
      visible: true,
      message: 'Are you sure you want to delete this budget item? This action cannot be undone.',
      onConfirm: () => confirmDeleteBudget(id),
      onCancel: () => setConfirmModal({ visible: false, message: '', onConfirm: null }),
    });
  };

  const confirmDeleteBudget = async (id) => {
    setConfirmModal({ visible: false, message: '', onConfirm: null });
    if (!db || !userId) return;
    try {
      await deleteDoc(doc(db, `/artifacts/${appId}/users/${userId}/budgets`, id));
    } catch (e) {
      console.error("Error deleting budget: ", e);
    }
  };

  return (
    <>
      <div className="flex flex-wrap gap-2 mb-8 border-b border-gray-200">
        <button
          onClick={() => setReportType('pnl')}
          className={`px-4 py-2 font-semibold transition-colors duration-200 ${reportType === 'pnl' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-gray-500 hover:text-indigo-600'}`}
        >
          Profit & Loss Statement
        </button>
        <button
          onClick={() => setReportType('budget')}
          className={`px-4 py-2 font-semibold transition-colors duration-200 ${reportType === 'budget' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-gray-500 hover:text-indigo-600'}`}
        >
          Budget Tracking
        </button>
      </div>

      {reportType === 'pnl' ? (
        <div className="bg-gray-50 rounded-xl p-6 shadow-md">
          <h3 className="text-2xl font-bold text-gray-800 mb-4">Profit & Loss Statement</h3>
          <div className="mb-6">
            <h4 className="text-xl font-semibold mb-2 text-gray-700">Income</h4>
            <div className="overflow-x-auto rounded-lg shadow-sm">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-white">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-64">Category</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {Object.keys(pnlData.incomeBySource).map(category => (
                    <tr key={category}>
                      <td className="px-6 py-4 whitespace-nowrap">{category}</td>
                      <td className="px-6 py-4 whitespace-nowrap">{formatZAR(pnlData.incomeBySource[category])}</td>
                    </tr>
                  ))}
                  <tr className="bg-gray-100 font-bold">
                    <td className="px-6 py-4">Total Income</td>
                    <td className="px-6 py-4">{formatZAR(pnlData.totalIncome)}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div className="mb-6">
            <h4 className="text-xl font-semibold mb-2 text-gray-700">Expenses</h4>
            <div className="overflow-x-auto rounded-lg shadow-sm">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-white">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-64">Category</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {Object.keys(pnlData.expensesByCategory).map(category => (
                    <tr key={category}>
                      <td className="px-6 py-4 whitespace-nowrap">{category}</td>
                      <td className="px-6 py-4 whitespace-nowrap">{formatZAR(pnlData.expensesByCategory[category])}</td>
                    </tr>
                  ))}
                  <tr className="bg-gray-100 font-bold">
                    <td className="px-6 py-4">Total Expenses</td>
                    <td className="px-6 py-4">{formatZAR(pnlData.totalExpenses)}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div className="text-right mt-6">
            <p className="text-lg font-bold text-gray-800">Net Profit/Loss: <span className={pnlData.netProfit >= 0 ? "text-green-600" : "text-red-600"}>{formatZAR(pnlData.netProfit)}</span></p>
          </div>
        </div>
      ) : (
        <div className="bg-gray-50 rounded-xl p-6 shadow-md">
          <h3 className="text-2xl font-bold text-gray-800 mb-4">Budget Tracking</h3>
          <p className="text-gray-600 mb-4">Set budget goals for your expense categories and track your spending against them.</p>
          <button
            onClick={handleAddBudget}
            className="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200 mb-4"
          >
            Add Budget
          </button>
          <div className="overflow-x-auto rounded-lg shadow-md">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-white">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48">Category</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Budgeted (R)</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Actual (R)</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Variance (R)</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48">Notes</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Actions</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {budgetData.map(budget => (
                  <tr key={budget.id}>
                    <td className="px-6 py-4"><input type="text" value={budget.category} onChange={(e) => handleUpdateBudget(budget, 'category', e.target.value)} className="w-full bg-transparent" /></td>
                    <td className="px-6 py-4"><input type="number" value={isNaN(budget.amount) ? '' : budget.amount} onChange={(e) => handleUpdateBudget(budget, 'amount', parseFloat(e.target.value) || 0)} className="w-full bg-transparent" /></td>
                    <td className="px-6 py-4 text-gray-700">{formatZAR(budget.actual)}</td>
                    <td className="px-6 py-4">
                      <span className={budget.variance >= 0 ? "text-green-600" : "text-red-600"}>
                        {formatZAR(budget.variance)}
                      </span>
                    </td>
                    <td className="px-6 py-4"><input type="text" value={budget.notes} onChange={(e) => handleUpdateBudget(budget, 'notes', e.target.value)} className="w-full bg-transparent" /></td>
                    <td className="px-6 py-4">
                      <button onClick={() => handleDeleteBudget(budget.id)} className="text-red-600 hover:text-red-900 transition-colors duration-200">
                        Delete
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}
      {confirmModal.visible && (
        <ConfirmationModal
          message={confirmModal.message}
          onConfirm={confirmModal.onConfirm}
          onCancel={() => setConfirmModal({ visible: false })}
        />
      )}
    </>
  );
};

export default App;
